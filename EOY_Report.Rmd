---
title: "SEUG Annual Climate Report"
author: "Matthew Van Scoyoc"
date: "October 26, 2017"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document:
    reference_docx: WordReferenceStyle.docx
---

```{r Setup, eval=T, echo=F, message=F, warning=F}
#-- Packages
# install.packages(c("tidyverse", "lubridate", "xlsx"))
#library("xlsx") # Import and export Microsoft Excel workbooks
library("rnoaa")
library("tidyverse") # Data manipulation
library("lubridate") # Easily work with date/time data
library("knitr")

#-- Figure Themes
# ggplot theme settings
my.theme <- theme(strip.background = element_rect(fill="white"), 
                  strip.text = element_text(hjust = 0.1), 
                  axis.title.x = element_blank(), 
                  legend.key = element_blank(), 
                  legend.position = c(0.85, 0.15), 
                  legend.title = element_blank(), 
                  legend.direction = "vertical", 
                  plot.title = element_text(hjust = 0.5))
```

# Introduction

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Data, eval=T, echo=F, message=F, warning=F}
#-- Designate target water year
my.yr = 2017

#-- Load .RData
load("Climate.RData")
dwnld.date.long <- paste(month.abb[month(download.date)], 
                         paste0(day(download.date), ","), 
                         year(download.date), sep = " ")

# Designate factor levels so data sort as desired
stations.seug$labels = factor(c("Arches", "CANY - Island in the Sky", 
                           "CANY - The Needles", "CANY - Hans Flat", 
                           "Hovenweep", "Moab", "Natural Bridges"), 
                         levels = c("Arches", "CANY - Hans Flat", 
                                    "CANY - Island in the Sky",  
                                    "CANY - The Needles", "Hovenweep", 
                                    "Natural Bridges", "Moab"))

# Designate factor levels so data sort as desired
dat <- dat %>%
  left_join(select(stations.seug, id, Station)) %>%
  mutate(Month = factor(month.abb[month(Date)], levels = month.abb), 
         Year = year(Date)) %>%
  filter(Year <= my.yr) %>%
  filter(Station != "MOAB")
```

# Southeast Utah Group
List of weather stations used in these analyses.
```{r WxStations, echo=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
station.sum <- stations.seug %>%
  filter(id %in% unique(dat$id)) %>%
  select(labels, latitude, longitude, elevation, first_year, last_year) %>%
  rename(Station = labels, 
         Latitude = latitude, 
         Longitude = longitude, 
         Elevation = elevation, 
         FirstYear = first_year, 
         LastYear = last_year) %>%
  arrange(Station)

print(kable(station.sum, caption = "SEUG Wx Stations"))
```

## Temperature
```{r Temps, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
#-- Subset data
temp.dat <- dat %>%
  filter(Element %in% c("TMAX", "TMIN")) %>%
  mutate(Value = ((Value * 0.1) * 1.8) + 32)  # Convert ?C (in tenths) to ?F

#-- 30-yr Stats (1981-2010 water years)
temps.30yr <- temp.dat %>%
  filter(Year >= 1981 & Year <= 2010) %>%
  group_by(Element) %>%
  summarise(Mean.30yr = mean(Value, na.rm = T),
            P90.30yr = quantile(Value, 0.90, na.rm = T), 
            sd.30yr = sd(Value, na.rm = T))

#-- Calculate monthly departures & rank
temps.depart <- temp.dat %>%
  group_by(Element, Year) %>%
  summarise(Mean = mean(Value, na.rm = T)) %>%
  left_join(temps.30yr) %>%
  mutate(Departure = Mean - Mean.30yr, 
         Warmest = min_rank(-Departure),
         Coolest = min_rank(Departure))

#-- Summary table
rec.warm <- temps.depart %>%
  filter(Warmest == 1) %>%
  select(Element, Year, Departure) %>%
  rename(WarmestYear = Year, 
         WarmestDeparture = Departure)
rec.cool <- temps.depart %>%
  filter(Coolest == 1) %>%
  select(Element, Year, Departure) %>%
  rename(CoolestYear = Year, 
         CoolestDeparture = Departure)
sum.tab <- temps.depart %>%
  filter(Year == my.yr) %>%
  select(Element, Departure, Warmest, Coolest) %>%
  left_join(rec.warm) %>%
  left_join(rec.cool)

print(kable(sum.tab, caption = "Summary of all SEUG data", digits = 2))
```

```{r TempFig, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
# Plot figure
my.title <- "Annual temperature departure from 1981-2010 average"
t1 <- ggplot(temps.depart, aes(x = Year, y = Departure)) +
  geom_bar(data = filter(temps.depart, Departure >= 0), stat = "identity",
           position = position_dodge(), color = "black", fill = "red") +
  geom_bar(data = filter(temps.depart, Departure < 0), stat = "identity",
           position = position_dodge(), color = "black", fill = "blue") +
  geom_hline(aes(yintercept = 0), linetype="solid", size = 1.0, 
             color = "black") +
  facet_wrap(~ Element) +
  labs(x = "Year", y = "Departure (?F)", title = my.title) +
  theme_bw() +
  my.theme
t1
```

## Precipitation
```{r PRCP.ann, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
#-- Reference dataframes
water.mths <- tibble(Month = factor(c(month.abb[10:12], month.abb[1:9]), 
                                    levels = c(month.abb[10:12], 
                                               month.abb[1:9])), 
                     WaterMonth = factor(1:12, levels = 1:12))
#-- Subset data
prcp.dat <- dat %>%
  filter(Element == "PRCP") %>%
  mutate(Value = Value / 254, # Convert to inches 
         WaterYr = ifelse(Month %in% c("Sep", "Oct", "Nov", "Dec"), 
                          Year + 1, Year), 
         key = paste(Station, WaterYr, sep = ".")) %>%
  left_join(water.mths)

# Calculate complete water years to clean data later
wy.complete <- prcp.dat %>%
  group_by(Station, WaterYr, WaterMonth) %>%
  summarise(Obs = sum(Value)) %>%
  group_by(Station, WaterYr) %>%
  summarise(n = n()) %>%
  filter(n == 12) %>%
  mutate(key = paste(Station, WaterYr, sep = "."))

#-- 30-yr Stats (1981-2010 water years)
prcp.30yr.ann = prcp.dat %>%
  filter(WaterYr >= 1981 & WaterYr <= 2010) %>%
  group_by(Element, Station, WaterYr) %>%
  summarise(Obs = sum(Value, na.rm = T)) %>%
  group_by(Element) %>%
  summarise(Mean.30yr = mean(Obs))

#-- Calculate annual averages & rank
prcp.ann <- prcp.dat %>%
  filter(key %in% wy.complete$key) %>%
  group_by(Element, Station, WaterYr) %>%
  summarise(Obs = sum(Value, na.rm = T)) %>%
  group_by(Element, WaterYr) %>%
  summarise(Obs.mean = mean(Obs)) %>%
  left_join(prcp.30yr.ann) %>%
  mutate(PctAvg = (Obs.mean / Mean.30yr) * 100, 
         Wettest = min_rank(-PctAvg),
         Driest = min_rank(PctAvg))

#-- Summary table
rec.dry <- prcp.ann %>%
  filter(Driest == 1) %>%
  select(Element, WaterYr, PctAvg) %>%
  rename(DriestWY = WaterYr, 
         DriestPctAvg = PctAvg)
rec.wet <- prcp.ann %>%
  filter(Wettest == 1) %>%
  select(Element, WaterYr, PctAvg) %>%
  rename(WettestWY = WaterYr, 
         WettestPctAvg = PctAvg)
sum.tab <- prcp.ann %>%
  filter(WaterYr == my.yr) %>%
  select(Element, PctAvg, Driest, Wettest) %>%
  left_join(rec.dry) %>%
  left_join(rec.wet)

print(kable(sum.tab, caption = "Summary of all SEUG data", digits = 2))
```

```{r PRCP.fig1, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
my.title <- "Percent annual precipitation\n(1981-2010 average)"
p1 <- ggplot(prcp.ann, aes(x = WaterYr, y = PctAvg)) +
  geom_bar(stat = "identity", position = position_dodge(), color = "black", 
           fill = "green4") +
  geom_hline(aes(yintercept = 100), linetype="dashed", size = 1.0, 
             color = "black") +
  labs(x = "Water Year", y = "Percent Average", title = my.title) +
  theme_bw() +
  my.theme
p1
```

```{r PRCP.mth, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#-- 30-yr Stats (1981-2010 water years)
# Water year stats
prcp.30yr.wymth <- prcp.dat %>%
  filter(WaterYr >= 1981 & WaterYr <= 2010) %>%
  group_by(Station, WaterYr, WaterMonth) %>%
  summarise(Mth.Obs = sum(Value, na.rm = T)) %>%
  mutate(WY.Obs = cumsum(Mth.Obs)) %>%
  group_by(WaterMonth) %>%
  summarise(WY.30yr = mean(WY.Obs))
# Final dataframe - Monthly and water year stats
prcp.30yr.mth <- prcp.dat %>%
  filter(WaterYr >= 1981 & WaterYr <= 2010) %>%
  group_by(Station, WaterYr, WaterMonth) %>%
  summarise(Mth.Obs = sum(Value, na.rm = T)) %>%
  group_by(WaterMonth) %>%
  summarise(Mth.30yr = mean(Mth.Obs)) %>%
  left_join(prcp.30yr.wymth) %>%
  left_join(water.mths)

#-- Calculate monthly averages and rank
# Water year
prcp.wy <- prcp.dat %>%
  filter(key %in% wy.complete$key) %>%
  group_by(Station, WaterYr, WaterMonth) %>%
  summarise(Mth.Obs = sum(Value, na.rm = T)) %>%
  mutate(WY.Obs = cumsum(Mth.Obs)) %>%
  group_by(WaterYr, WaterMonth) %>%
  summarise(SEUG.wy = mean(WY.Obs)) %>%
  left_join(prcp.30yr.wymth) %>%
  mutate(PctAvg.wy = SEUG.wy / WY.30yr * 100) %>%
  left_join(water.mths) %>%
  group_by(WaterMonth) %>%
  mutate(WY.Driest = min_rank(PctAvg.wy), 
         WY.Wettest = min_rank(-PctAvg.wy), 
         Year = ifelse(WaterMonth %in% 1:3, WaterYr - 1, WaterYr),
         Date = mdy(paste(Month, 15, Year, sep = "-")))
# Monthly and water year
prcp.mth <- prcp.dat %>%
  filter(key %in% wy.complete$key) %>%
  group_by(Station, WaterYr, WaterMonth) %>%
  summarise(Mth.Obs = sum(Value, na.rm = T)) %>%
  group_by(WaterYr, WaterMonth) %>%
  summarise(SEUG.mth = mean(Mth.Obs)) %>%
  left_join(select(prcp.30yr.mth, -WY.30yr, -Month)) %>%
  mutate(PctAvg.mth = SEUG.mth / Mth.30yr * 100) %>%
  left_join(water.mths) %>%
  group_by(WaterMonth) %>%
  mutate(WY.Driest = min_rank(PctAvg.mth), 
         WY.Wettest = min_rank(-PctAvg.mth), 
         Year = ifelse(WaterMonth %in% 1:3, WaterYr - 1, WaterYr),
         Date = mdy(paste(Month, 15, Year, sep = "-")))
```

```{r PRCP.fig2, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
my.title <- "Water year precipitation accumulation\n(1981-2010 Average)"
p2 <- ggplot(prcp.mth, aes(x = Month, y = PctAvg.mth, group = WaterYr)) +
  geom_line(stat = "identity", color = "gray") +
  geom_line(data = filter(prcp.mth, WaterYr == my.yr), stat = "identity", 
            color = "red", size = 2) +
  geom_hline(aes(yintercept = 100), linetype="dashed", size = 1.0, 
             color = "black") +
  labs(y = "Percent Average", title = my.title) +
  theme_bw() +
  my.theme
p2
```

```{r Versions, eval=TRUE, echo=FALSE}
info <- sessionInfo()
r.ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```
The data for these analyses were downloaded from the Global Historic Climate Network on `r dwnld.date.long` using R (ver. `r r.ver`, R Core Team, 2017) and the rnoaa package (ver `r info$otherPkgs$rnoaa$Version`, Chamberlain, et al. 2017).

```{r EndScript, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
now()
info
```